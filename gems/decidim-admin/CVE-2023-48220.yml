---
gem: decidim-admin
cve: 2023-48220
ghsa: w3q8-m492-4pwp
url: https://github.com/decidim/decidim/security/advisories/GHSA-w3q8-m492-4pwp
title: Possibility to circumvent the invitation token expiry period
date: 2024-02-20
description: |-
  ### Impact
  The invites feature allows users to accept the invitation for an unlimited amount of time through the password reset functionality.

  When using the password reset functionality, the `devise_invitable` gem always accepts the pending invitation if the user has been invited as shown in this piece of code within the `devise_invitable` gem:
  https://github.com/scambra/devise_invitable/blob/41f58970ff76fb64382a9b9ea1bd530f7c3adab2/lib/devise_invitable/models.rb#L198

  The only check done here is if the user has been invited but the code does not ensure that the pending invitation is still valid as defined by the `invite_for` expiry period as explained in the gem's documentation:
  https://github.com/scambra/devise_invitable#model-configuration-

  > `invite_for`: The period the generated invitation token is valid. After this period, the invited resource won’t be able to accept the invitation. When `invite_for` is `0` (the default), the invitation won’t expire.

  Decidim sets this configuration to `2.weeks` so this configuration should be respected:
  https://github.com/decidim/decidim/blob/d2d390578050772d1bdb6d731395f1afc39dcbfc/decidim-core/config/initializers/devise.rb#L134

  The bug is in the `devise_invitable` gem and should be fixed there and the dependency should be upgraded in Decidim once the fix becomes available.

  ### Patches
  Update `devise_invitable` to version `2.0.9` or above by running the following command:

  ```
  $ bundle update devise_invitable
  ```

  ### Workarounds
  The invitations can be cancelled directly from the database by running the following command from the Rails console:

  ```
  > Decidim::User.invitation_not_accepted.update_all(invitation_token: nil)
  ```

  ### References
  OWASP ASVS V4.0.3-2.3.1

  This bug has existed in the `devise_invitable` gem since this commit which was first included in the `v0.4.rc3` release of this gem:
  https://github.com/scambra/devise_invitable/commit/94d859c7de0829bf63f679ae5dd3cab2b866a098

  All versions since then are affected.

  This gem was first introduced at its version `~> 1.7.0` to the `decidim-admin` gem in this commit which was first included in the `v0.0.1.alpha3` release of Decidim:
  https://github.com/decidim/decidim/commit/073e60e2e4224dd81815a784002ebba30f2ebb34

  It was first introduced at its version `~> 1.7.0` to the `decidim-system` gem in this commit which was also first included in the `v0.0.1.alpha3` release of Decidim:
  https://github.com/decidim/decidim/commit/b12800717a689c295a9ea680a38ca9f823d2c454

  ### Credits
  This issue was discovered in City of Helsinki's security audit against Decidim 0.27 done during September 2023. The security audit was implemented by [Deloitte Finland](https://www2.deloitte.com/fi/fi.html).
cvss_v3: 5.7
unaffected_versions:
- "<OPTIONAL: FILL IN SEE BELOW>"
patched_versions:
- "<FILL IN SEE BELOW>"


# GitHub advisory data below - **Remove this data before committing**
# Use this data to write patched_versions (and potentially unaffected_versions) above
---
identifiers:
- type: GHSA
  value: GHSA-w3q8-m492-4pwp
- type: CVE
  value: CVE-2023-48220
summary: Possibility to circumvent the invitation token expiry period
description: |-
  ### Impact
  The invites feature allows users to accept the invitation for an unlimited amount of time through the password reset functionality.

  When using the password reset functionality, the `devise_invitable` gem always accepts the pending invitation if the user has been invited as shown in this piece of code within the `devise_invitable` gem:
  https://github.com/scambra/devise_invitable/blob/41f58970ff76fb64382a9b9ea1bd530f7c3adab2/lib/devise_invitable/models.rb#L198

  The only check done here is if the user has been invited but the code does not ensure that the pending invitation is still valid as defined by the `invite_for` expiry period as explained in the gem's documentation:
  https://github.com/scambra/devise_invitable#model-configuration-

  > `invite_for`: The period the generated invitation token is valid. After this period, the invited resource won’t be able to accept the invitation. When `invite_for` is `0` (the default), the invitation won’t expire.

  Decidim sets this configuration to `2.weeks` so this configuration should be respected:
  https://github.com/decidim/decidim/blob/d2d390578050772d1bdb6d731395f1afc39dcbfc/decidim-core/config/initializers/devise.rb#L134

  The bug is in the `devise_invitable` gem and should be fixed there and the dependency should be upgraded in Decidim once the fix becomes available.

  ### Patches
  Update `devise_invitable` to version `2.0.9` or above by running the following command:

  ```
  $ bundle update devise_invitable
  ```

  ### Workarounds
  The invitations can be cancelled directly from the database by running the following command from the Rails console:

  ```
  > Decidim::User.invitation_not_accepted.update_all(invitation_token: nil)
  ```

  ### References
  OWASP ASVS V4.0.3-2.3.1

  This bug has existed in the `devise_invitable` gem since this commit which was first included in the `v0.4.rc3` release of this gem:
  https://github.com/scambra/devise_invitable/commit/94d859c7de0829bf63f679ae5dd3cab2b866a098

  All versions since then are affected.

  This gem was first introduced at its version `~> 1.7.0` to the `decidim-admin` gem in this commit which was first included in the `v0.0.1.alpha3` release of Decidim:
  https://github.com/decidim/decidim/commit/073e60e2e4224dd81815a784002ebba30f2ebb34

  It was first introduced at its version `~> 1.7.0` to the `decidim-system` gem in this commit which was also first included in the `v0.0.1.alpha3` release of Decidim:
  https://github.com/decidim/decidim/commit/b12800717a689c295a9ea680a38ca9f823d2c454

  ### Credits
  This issue was discovered in City of Helsinki's security audit against Decidim 0.27 done during September 2023. The security audit was implemented by [Deloitte Finland](https://www2.deloitte.com/fi/fi.html).
severity: MODERATE
cvss:
  score: 5.7
  vectorString: CVSS:3.1/AV:N/AC:H/PR:H/UI:R/S:U/C:H/I:H/A:N
references:
- url: https://github.com/decidim/decidim/security/advisories/GHSA-w3q8-m492-4pwp
- url: https://nvd.nist.gov/vuln/detail/CVE-2023-48220
- url: https://github.com/decidim/decidim/commit/073e60e2e4224dd81815a784002ebba30f2ebb34
- url: https://github.com/decidim/decidim/commit/b12800717a689c295a9ea680a38ca9f823d2c454
- url: https://github.com/scambra/devise_invitable/commit/94d859c7de0829bf63f679ae5dd3cab2b866a098
- url: https://github.com/decidim/decidim/blob/d2d390578050772d1bdb6d731395f1afc39dcbfc/decidim-core/config/initializers/devise.rb#L134
- url: https://github.com/decidim/decidim/releases/tag/v0.26.9
- url: https://github.com/decidim/decidim/releases/tag/v0.27.5
- url: https://github.com/decidim/decidim/releases/tag/v0.28.0
- url: https://github.com/scambra/devise_invitable/blob/41f58970ff76fb64382a9b9ea1bd530f7c3adab2/lib/devise_invitable/models.rb#L198
- url: https://github.com/advisories/GHSA-w3q8-m492-4pwp
publishedAt: '2024-02-20T19:26:51Z'
withdrawnAt: 
vulnerabilities:
- package:
    name: decidim-system
    ecosystem: RUBYGEMS
  vulnerableVersionRange: ">= 0.27.0, < 0.27.5"
  firstPatchedVersion:
    identifier: 0.27.5
- package:
    name: decidim-admin
    ecosystem: RUBYGEMS
  vulnerableVersionRange: ">= 0.27.0, < 0.27.5"
  firstPatchedVersion:
    identifier: 0.27.5
- package:
    name: decidim
    ecosystem: RUBYGEMS
  vulnerableVersionRange: ">= 0.27.0, < 0.27.5"
  firstPatchedVersion:
    identifier: 0.27.5
- package:
    name: devise_invitable
    ecosystem: RUBYGEMS
  vulnerableVersionRange: ">= 0.4.rc3, < 2.0.9"
  firstPatchedVersion:
    identifier: 2.0.9
- package:
    name: decidim-system
    ecosystem: RUBYGEMS
  vulnerableVersionRange: ">= 0.0.1.alpha3, < 0.26.9"
  firstPatchedVersion:
    identifier: 0.26.9
- package:
    name: decidim-admin
    ecosystem: RUBYGEMS
  vulnerableVersionRange: ">= 0.0.1.alpha3, < 0.26.9"
  firstPatchedVersion:
    identifier: 0.26.9
- package:
    name: decidim
    ecosystem: RUBYGEMS
  vulnerableVersionRange: ">= 0.0.1.alpha3, < 0.26.9"
  firstPatchedVersion:
    identifier: 0.26.9
